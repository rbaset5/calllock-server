# Issues #33-#39 Design: Card Display, Classification Gaps, Quality Score

**Date:** 2026-02-14
**Issues:** #33, #34, #35, #36, #37, #39 (skipping #38 — deferred)
**Status:** Approved

## Summary

Six bugs found via call audit. Three groups:
- **Card display** (#33, #34): `card_headline` and `card_summary` duplicate `ai_summary`
- **Classification gaps** (#35, #36, #37): Equipment type, urgency tags, and caller type fall to defaults when data exists
- **Quality score** (#39): Score computed but never persisted

## Group A: Card Display (#33, #34)

### Problem

`buildCardHeadline()` truncates `call_summary` first sentence. `buildCardSummary()` returns `call_summary` directly. Both produce the same text as `ai_summary`, which also sources from `call_summary`.

### Design

**`buildCardHeadline()` — template-based, max 60 chars:**

1. Derive `serviceLabel` from `call_subtype` or `tags.SERVICE_TYPE[0]` (e.g., "AC Repair", "Heating Install")
2. Add equipment context if available (e.g., "Central Air", "Furnace")
3. Add urgency badge if high/emergency (e.g., "URGENT")
4. Template: `"{serviceLabel} — {equipment} | {urgency}"` or `"{serviceLabel} — {equipment}"` if routine
5. Fallback to `state.problemDescription` truncated if no structured data
6. Never use `call_summary` — reserved for `ai_summary`

Examples:
- `"AC Repair — Central Air | Urgent"`
- `"Heating Diagnostic — Furnace"`
- `"New System Install — Heat Pump"`
- `"Plumbing Repair"` (minimal data)

**`buildCardSummary()` — action-oriented, max 200 chars:**

1. Build from state: `"{callerName} called about {problemDescription}."`
2. Append booking outcome: `"Appointment booked for {dateTime}."` / `"Callback requested."` / `"No booking made."`
3. Append urgency if high: `"Flagged as urgent — {urgencyReason}."`
4. Fallback to assembled parts from state (equipment, age, etc.)
5. Never use `call_summary` — distinct from `ai_summary` by construction

Examples:
- `"John Smith called about AC not cooling. Appointment booked for Feb 15 at 10am."`
- `"Mary Jones called about gas smell from furnace. Flagged as urgent — life safety. Callback requested."`

### Files Changed

- `V2/src/services/dashboard.ts` — rewrite `buildCardHeadline()` and `buildCardSummary()`

## Group B: Classification Gaps (#35, #36, #37)

### #35 — equipment_type='unknown' for AC calls

**Problem:** `extractEquipmentTypeFromTranscript()` regex patterns miss simple mentions like "AC stopped working".

**Fix:**
1. Expand regex — add standalone "AC" match (case-insensitive, word-boundary: `\bac\b`)
2. Add `call_subtype` fallback in payload construction: `state.equipmentType → transcript mining → call_subtype mapping → "unknown"`

### #36 — URGENCY tags empty when urgency=high

**Problem:** Tag classifier doesn't cross-reference `state.urgency`/`urgencyTier`. Transcript may not contain urgency keywords even when the agent flagged urgency.

**Fix:** In `classifyCall()`, after transcript-based classification:
1. If `tags.URGENCY` empty AND (`state.urgency === 'high'` OR `state.urgencyTier === 'Urgent'`) → auto-emit `URGENT_24HR`
2. If `tags.URGENCY` empty AND (`state.urgency === 'emergency'` OR `state.urgencyTier === 'LifeSafety'`) → auto-emit `EMERGENCY_SAMEDAY`

Mirrors existing auto-upgrade pattern for HAZARD → urgency.

### #37 — caller_type='unknown' for residential service calls

**Problem:** `deriveCallerType()` returns "unknown" when no tags match, even for standard residential calls.

**Fix:** Change fallback logic:
1. If no tags match BUT `tags.SERVICE_TYPE` non-empty → return `"residential"`
2. If no tags at all BUT `state.problemDescription` exists → return `"residential"`
3. True "unknown" only for genuinely empty calls (hang-up, no data)

Rationale: HVAC company calls default to residential. Commercial/vendor/recruiting need positive signals.

### Files Changed

- `V2/src/services/dashboard.ts` — expand equipment regex, add call_subtype fallback, fix caller_type fallback
- `V2/src/classification/tags.ts` — add urgency cross-reference after classification

## Group C: Quality Score Persistence (#39)

### Problem

Quality score is computed and logged in post-call webhook but never stored.

### Design

1. **Database:** Add `quality_score INTEGER` column to `call_sessions` table
2. **V2 Backend:** Persist score via existing upsert in post-call webhook handler
3. **Dashboard payload:** Add `quality_score` to calls webhook payload
4. **Dashboard DB:** Add column to dashboard calls table to receive and store it

### Files Changed

- `V2/src/server.ts` — include quality_score in call_sessions upsert and calls webhook payload
- Supabase migration — `ALTER TABLE call_sessions ADD COLUMN quality_score INTEGER`
- Dashboard migration — add column to calls table

## Testing Strategy

Each fix gets a failing test first (per development discipline):

- **#33/#34:** Test `buildCardHeadline()` and `buildCardSummary()` output differs from `call_summary`
- **#35:** Test with transcript containing "AC stopped working" → expect equipment_type="AC"
- **#36:** Test with `state.urgency='high'` and empty transcript → expect URGENT_24HR tag
- **#37:** Test with SERVICE_TYPE tags present, no CUSTOMER tags → expect caller_type="residential"
- **#39:** Test that quality_score appears in upsert payload and webhook payload

## Deployment

Single branch, single PR. All changes are in V2 backend (except DB migrations).

1. Apply Supabase migration (add quality_score column)
2. Deploy V2 backend with all fixes
3. Apply dashboard migration (if dashboard changes needed)

No breaking changes — all fixes are additive or change defaults from "unknown" to correct values.
